# 智能视频合成与防重复系统 — 技术可行性文档

## 文档信息

| 项目 | 说明 |
|------|------|
| 文档名称 | Feasibility.md |
| 版本 | v1.0 |
| 目标 | 基于 Agent 的云端素材库 + 分镜脚本驱动的自动化视频合成，并实现强防重复机制 |

---

## 一、项目概述与目标

### 1.1 业务目标

- **云端素材库**：集中管理我方上传的邮轮实拍视频及接入的国内景区可商用高清素材。
- **标准化分镜脚本**：多套「分镜脚本」（Shot List）驱动选片与合成，支持用户片段在指定位置插入。
- **全自动合成**：由服务端完成剪辑、合成、配乐、字幕，无需人工介入单条视频生产。
- **原创度保障**：通过随机化与查重机制，使每条成片通过抖音、小红书等平台的重复度检测，降低限流风险。

### 1.2 核心约束

- 素材需可商用（版权清晰）。
- 合成流程需可编排、可扩展（便于后续增加分镜模板）。
- 防重复为「核心关键」，需在架构中单独成模块并优先设计。

---

## 二、系统架构总览

### 2.1 高层架构图（逻辑）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户 / 运营侧                                       │
│  上传素材 │ 选择分镜脚本 │ 上传自定义片段 │ 触发生成 │ 查看历史成片              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API 网关 / 任务队列                                   │
│  请求鉴权、限流、任务入队（Celery / Dramatiq / 云函数）                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
          ┌───────────────────────────┼───────────────────────────┐
          ▼                           ▼                           ▼
┌──────────────────┐    ┌──────────────────────────┐    ┌──────────────────────┐
│  素材库服务       │    │  视频合成 Agent 编排层    │    │  防重复与查重服务     │
│  - 上传/元数据    │    │  - 解析分镜脚本           │    │  - 帧哈希/特征提取    │
│  - 检索与标签    │    │  - 选片与片段匹配         │    │  - 历史成片相似度     │
│  - 二次剪辑参数  │    │  - 调用剪辑/配乐/字幕     │    │  - 相似则触发重生成   │
└──────────────────┘    └──────────────────────────┘    └──────────────────────┘
          │                           │                           │
          └───────────────────────────┼───────────────────────────┘
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         执行层（Worker / 容器）                               │
│  剪辑引擎（FFmpeg）│ 配乐服务 │ 字幕服务 │ 存储（对象存储 + 数据库）             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Agent 在系统中的角色

- **编排 Agent**：解析分镜脚本 → 从素材库检索片段 → 决定转场/滤镜/缩放等随机参数 → 调用防重复模块做「预检」与「成片后检」→ 驱动剪辑管线。
- **可选技术形态**：LangChain/LangGraph（多步编排 + 人工可干预）、Agno、PydanticAI 等，用于「工作流定义 + 工具调用」，而不是替代 FFmpeg 做底层剪辑。

---

## 三、云端素材库设计

### 3.1 功能需求

- 支持我方上传大量邮轮实拍视频（上传、切片、元数据录入）。
- 支持接入或爬取一批**可商用**国内知名景区高清视频素材。
- 为每个片段维护：时长、分辨率、标签、来源、可商用声明、以及**防重复用**的多种「二次剪辑版本」引用（见第六节）。

### 3.2 数据模型（建议）

```yaml
# 素材实体
Asset:
  id: uuid
  type: "upload" | "scenic"   # 我方上传 | 景区接入
  source_file_path: str       # 原始文件 OSS 路径
  duration_sec: float
  resolution: "1080p" | "4k" 等
  metadata:
    tags: [str]               # 场景、地点、时间等
    shot_type: "wide" | "medium" | "close" | "detail"  # 可选，便于脚本匹配
    license: "internal" | "cc" | "purchased"
  created_at, updated_at

# 片段（可能由一条素材切出多段）
Clip:
  id: uuid
  asset_id: uuid
  in_point_sec: float
  out_point_sec: float
  duration_sec: float
  variant_id: uuid?            # 指向 ClipVariant（二次剪辑版本）
  metadata: { ... }

# 二次剪辑版本（防重复用）
ClipVariant:
  id: uuid
  clip_id: uuid
  transform: "original" | "mirror_h" | "mirror_v" | "speed_0.9" | "speed_1.1" | "crop_center" | ...
  output_path: str             # 预处理后的片段路径
  duration_sec: float
```

### 3.3 存储与检索

- **对象存储**：阿里云 OSS / 腾讯云 COS / MinIO，按 `bucket/type/year-month/id.ext` 组织。
- **检索**：按标签、时长、分辨率、shot_type、来源过滤；可选接入向量库（如 Milvus/Elasticsearch）做「语义检索」辅助选片（非必须第一版）。
- **预处理流水线**：上传或接入后，异步生成多版 ClipVariant（镜像、变速、裁剪等），供合成时随机选用。

---

## 四、可商用国内景区高清素材的接入与爬取

### 4.1 合规优先

- **优先**：与版权方/图库/景区合作，获取正式授权或使用明确标注可商用的素材（如部分省文旅、景区官网发布的宣传片、CC 协议素材）。
- **爬取**：若需爬取，仅限明确允许商用的来源，并记录 URL、授权类型、爬取时间，便于合规审计。

### 4.2 接入方式建议

| 方式 | 说明 | 实现要点 |
|------|------|----------|
| 开放 API | 部分文旅/图库提供 API | 定时同步元数据 + 下载链接，写入 Asset/Clip |
| 合作授权包 | 线下获取素材包 | 批量导入 + 元数据 CSV/JSON，校验 MD5 防重复 |
| 限定爬虫 | 仅爬明确可商用站点 | 遵守 robots.txt，限速，存 source_url + license 字段 |

### 4.3 爬虫实现要点（若采用）

- 框架：Scrapy 或 httpx + asyncio，配合任务队列逐批下载。
- 存储：先落库元数据（url、title、license、duration），再异步下载到 OSS 并更新 `source_file_path`。
- 去重：对 URL 或内容哈希做去重，避免同一视频多次入库。
- Agent 可参与：用 LangChain/Agno 调用「检索可商用来源」工具、或审核「某 URL 是否可商用」的规则/提示词，辅助人工抽检。

---

## 五、视频合成流程（分镜脚本驱动）

### 5.1 分镜脚本（Shot List）格式

建议采用结构化配置（如 JSON/YAML），便于程序解析与版本管理：

```yaml
# shot_list_cruise_scenic_v1.yaml
name: "邮轮+景区混剪模板 v1"
version: "1.0"
total_duration_target: 60  # 秒

shots:
  - slot: 1
    type: "library"           # 从素材库选
    constraints:
      tags: ["cruise", "deck", "wide"]
      duration_range: [5, 10]
      shot_type: "wide"
  - slot: 2
    type: "user_upload"       # 用户上传片段插入位
    user_slot_id: "intro"
    constraints:
      duration_range: [3, 8]
  - slot: 3
    type: "library"
    constraints:
      tags: ["scenic", "mountain", "china"]
      duration_range: [4, 8]
  - slot: 4
    type: "library"
    constraints:
      tags: ["cruise", "sunset"]
      duration_range: [5, 12]
  # ...
```

### 5.2 合成流程（与 Agent 的衔接）

1. **输入**：分镜脚本 ID + 用户上传片段（对应 `user_slot_id`）+ 可选随机种子。
2. **解析脚本**：Agent 或编排服务解析 YAML/JSON，得到有序的 slot 列表。
3. **选片**：
   - `type: library`：按 constraints 在素材库中检索，可引入随机化（同一约束下随机挑一条，且可随机选该条对应的 ClipVariant）。
   - `type: user_upload`：使用用户上传的片段，若超长则按脚本 `duration_range` 截取。
4. **随机化参数（防重复）**：
   - 为本次生成生成一组随机参数：转场类型（淡入淡出/闪白/无）、滤镜（无/轻微调色）、缩放/裁剪（中心 95%/随机偏移）等（见第六节）。
5. **防重复预检（可选）**：若历史成片库已有类似「脚本+参数」组合，可跳过或微调参数后再生成。
6. **执行剪辑**：按 slot 顺序 + 转场 + 滤镜调用 FFmpeg（或 GpuImage 等）生成一条成片。
7. **配乐与字幕**：从音乐库选 BGM（也可随机），字幕可按脚本 slot 或 ASR 结果生成并烧录。
8. **成片后查重**：对生成视频做帧哈希/特征提取，与历史成片库比对；若相似度过高则自动重新生成（更换选片或随机参数），直至通过或达到重试上限。

### 5.3 Agent 实现方式（框架选型概要）

- **LangGraph**：把「解析脚本 → 选片 → 随机化 → 预检 → 剪辑 → 后检 → 重试」做成状态图，节点内调用「素材库查询」「防重复服务」「FFmpeg 封装」等工具；适合复杂分支与重试逻辑。
- **LangChain**：用 Agent + Tools（检索素材、调用防重复 API、提交剪辑任务），逻辑更自由但需自行保证顺序与重试。
- **Agno**：可作为 Agent 运行时，工具同上，偏轻量。
- **PydanticAI**：用强类型 Model 描述「分镜解析结果」「选片结果」「随机参数」，适合与现有 Python 服务深度集成，工具调用用 Pydantic 校验入参出参。

推荐：**核心编排用 LangGraph 或 PydanticAI**，剪辑与查重仍由独立服务完成，Agent 只做「决策与调用」。

---

## 六、视频查重与防重复机制（核心）

目标：使每条成片在平台侧具备足够原创度，通过重复度检测。

### 6.1 策略分层

| 层级 | 手段 | 说明 |
|------|------|------|
| 素材层 | 多版本二次剪辑 | 每个片段保留多种变换版本，合成时随机选用 |
| 合成层 | 随机化参数 | 转场、滤镜、缩放/裁剪、BGM、字幕样式等 |
| 成片层 | 相似度检测与重生成 | 与历史成片做帧级/特征级对比，超阈值则重新生成 |

### 6.2 素材层：片段多版本二次剪辑

- **变换类型示例**：
  - 镜像：水平翻转 `hflip`、垂直翻转 `vflip`（根据内容谨慎使用）。
  - 变速：0.9x / 1.05x / 1.1x（保持音画同步时仅对无音轨或替换 BGM 的片段使用）。
  - 出入点：同一段素材取不同 in/out，生成多段 Clip；或对同一 Clip 做 ±0.5s 的滑动窗口多版本。
  - 裁剪：中心 95%、90%，或随机偏移 5% 内，再缩放到目标分辨率。
- **实现**：上传/接入时异步任务生成 ClipVariant，存 path 与 transform 类型；合成时按 slot 随机选「某 Clip 的某 Variant」。

### 6.3 合成层：随机化参数

- **转场**：在固定集合中随机（无转场、淡入淡出、闪白、简单位移），时长 0.3–0.8s 随机。
- **滤镜**：无 / 轻微对比度/饱和度/色温（LUT 或 FFmpeg 参数随机范围）。
- **画面**：每段可应用轻微随机缩放（如 1.0–1.05）或裁剪后再缩放，避免与「原片直出」完全一致。
- **BGM 与字幕**：多首 BGM 随机；字幕字体/大小/位置在安全范围内随机。
- **随机种子**：每次生成带 seed，便于复现与排查；同一 seed 下同一脚本理论上得到同一成片。

### 6.4 成片层：相似度检测与重生成

- **流程**：
  1. 成片生成完成后，对视频做**帧采样**（如每秒 1 帧或每 0.5 秒 1 帧）。
  2. 对每帧计算**感知哈希**（如 pHash、dHash）或**特征向量**（CNN 特征或传统特征），得到序列或向量集合。
  3. 与「历史成片库」中每条成片的对应表示做相似度计算：
     - 哈希：汉明距离或相似度百分比；
     - 特征：余弦相似度或 L2 距离。
  4. 若与任意历史成片的相似度 **高于设定阈值**，则判定为「过于相似」，触发重生成：更换选片和/或随机参数，重新走剪辑流程，再次检测，直至通过或达到最大重试次数。

- **实现建议**：
  - 帧哈希：OpenCV + imagehash（pHash/dHash）；存储为「成片 ID → 按时间序的哈希序列」。
  - 特征向量：用轻量模型（如 CLIP 或某帧特征模型）抽帧特征，存向量库（Milvus/FAISS）；相似度用 KNN 或阈值检索。
  - 性能：历史库较大时，可先做「粗筛」（如按脚本模板 + 日期段）再细比，或对哈希做索引加速。

### 6.5 防重复服务接口（建议）

- `POST /api/anti-duplicate/check`  
  - 入参：成片视频 URL 或临时 path、可选「排除的成片 ID」列表。  
  - 出参：`{ "passed": bool, "similar_video_ids": [...], "max_similarity": float }`  
- `GET /api/anti-duplicate/params`  
  - 返回当前随机化参数空间（转场类型、滤镜范围等），供编排层使用。  
- 内部：历史成片入库时异步计算帧哈希/特征并写入防重复库。

---

## 七、技术栈与实现细节汇总

### 7.1 推荐技术栈

| 模块 | 技术选型 | 说明 |
|------|----------|------|
| 编排 / Agent | LangGraph 或 PydanticAI | 分镜解析、选片、随机化、调用各服务 |
| 任务队列 | Celery + Redis 或 云函数 | 剪辑、预处理、爬虫等异步任务 |
| 剪辑执行 | FFmpeg（Python 封装） | 转场、滤镜、裁剪、拼接、字幕烧录 |
| 素材库 | PostgreSQL + 对象存储 | 元数据 + 文件；可选 Elasticsearch 做标签检索 |
| 防重复 | Python + imagehash/OpenCV + 向量库（可选） | 帧哈希 + 可选特征向量 |
| 配乐 | 固定 BGM 库 + 随机选择 | 或接入第三方版权音乐 API |
| 字幕 | 脚本预定义文案 或 ASR + 模板 | 烧录用 FFmpeg ass/srt |

### 7.2 关键实现细节

- **FFmpeg 转场示例**（淡入淡出）：  
  `xfade=transition=fade:duration=0.5` 等，按随机参数拼接 filter_complex。
- **字幕**：生成 .ass/.srt 后用 `subtitles` 或 `ass` filter 烧录，字体与样式可参数化。
- **并发与资源**：剪辑为 CPU/GPU 密集型，Worker 数量按机器核数配置；长片可拆为「分段渲染再拼接」以加速。
- **安全**：上传校验格式与大小；素材来源与 license 必填；爬虫仅限合规来源并留日志。

---

## 八、风险与可行性评估

### 8.1 风险

- **版权**：景区/第三方素材必须可商用，需法务与来源管理。
- **平台规则变化**：抖音、小红书检测算法会演进，需保留「相似度阈值」与随机强度可调，便于后续调参。
- **性能与成本**：全量帧特征存储与比对成本高，可先用帧哈希 + 抽样比对，再按需上向量检索。

### 8.2 可行性结论

- **素材库与分镜驱动合成**：现有技术（存储、FFmpeg、任务队列）即可实现，Agent 负责编排与参数化，**可行**。
- **景区素材接入**：以合作与明确可商用来源为主，爬虫为辅并严格合规，**可行**。
- **防重复**：多版本片段 + 合成随机化 + 成片相似度检测与重生成，三重手段叠加，**可显著提升原创度**；是否 100% 通过平台检测需上线后小批量 A/B 验证并迭代阈值与随机范围。

---

## 九、文档与后续步骤

- 本文档为**技术可行性说明**，不替代详细设计（如数据库 ER、API 契约、部署图）。
- 建议后续：  
  1）确定 Agent 框架（LangGraph vs PydanticAI）与防重复阈值策略；  
  2）做分镜脚本 schema 定版与 1～2 套模板试点；  
  3）实现最小闭环：素材库 + 单脚本合成 + 随机化 + 简易帧哈希查重；  
  4）再扩展景区素材接入与多脚本、多 BGM/字幕策略。

---

## 十、代码实现索引（本项目）

| 文档章节 | 对应代码路径 |
|----------|--------------|
| 三、云端素材库 | `models/asset.py`（Asset, Clip, ClipVariant）、`services/material_library.py` |
| 四、景区素材接入 | 可扩展 `services/material_library.py` + 爬虫任务 `tasks/` |
| 五、分镜与合成流程 | `models/shot_list.py`、`services/shot_list_parser.py`、`agent/graph.py`、`services/video_synthesis.py` |
| 六、防重复机制 | `services/anti_duplicate.py`、`models/anti_duplicate.py`、`tasks/clip_variant_tasks.py` |
| 七、技术栈 | `config/settings.py`、`api/main.py`、`requirements.txt` |
| 运行与演示 | `README.md`、`run_synthesis_demo.py`、`shot_lists/cruise_scenic_v1.yaml` |
